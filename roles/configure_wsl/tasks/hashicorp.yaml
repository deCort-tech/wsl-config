---
- name: Get Hashicorp GPG key
  ansible.builtin.get_url:
    url: "{{ hashicorp_gpg_url }}"
    dest: "/tmp/hashicorp_gpg"

- name: Add the Hashicorp GPG key
  shell: 
    cmd: "gpg --dearmor /tmp/hashicorp_gpg && mv /tmp/hashicorp_gpg.gpg {{ hashicorp_gpg_keyring }}"
  become: true

- name: Verify the GPG key register as verify_gpg
  shell:
    cmd: "gpg --no-default-keyring --keyring {{ hashicorp_gpg_keyring }} --fingerprint"
  register: verify_gpg

- name: Do the actual verification with the known good --fingerprint"
  ansible.builtin.fail:
    msg: "Hashicorp GPG Key does not match with known good fingerprint"
  when:  "'E8A0 32E0 94D8 EB4E A189 D270 DA41 8C88 A321 9F7B' not in verify_gpg"

- name: Add the Packer repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ hashicorp_gpg_keyring }} arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    state: present

- name: Add the Terraform repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ hashicorp_gpg_keyring }} arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"

- name: Download package information
  ansible.builtin.apt:
    update_cache: yes
  
- name: Install Packer
  ansible.builtin.apt:
    name: packer={{ packer_version }}
    state: present

- name: Install Terraform
  ansible.builtin.apt:
    name: terraform={{ terraform_version }}
    state: present

- name: Check if Packer is correctly installed
  ansible.builtin.command:
    cmd: packer --version

- name: Check if Terraform is correctly installed
  ansible.builtin.command:
    cmd: terraform -version